<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Video</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/jquery-1.6.2.min.js"></script>
    <script src="/js/froogaloop2.min.js"></script>
    <script>

    var username_is_set = false,
        nickname = false,
        video_queue = [],
        old_video_queue = [],
        current_video = null;
        
    function addEvent(element, eventName, callback) {
        if (element.addEventListener) {
            element.addEventListener(eventName, callback, false);
        }
        else {
            element.attachEvent(eventName, callback, false);
        }
    }

    function setup_event_listners(){
        var froogaloop = $f(document.querySelectorAll('iframe')[0]);
        froogaloop.addEvent('finish',play_next_video);
    }

    function ready() {
        setup_event_listners();
    }

    function embedVideo(video) {
        document.getElementById('embed').innerHTML = unescape(video.html);

        /**
         * Utility function for adding an event. Handles the inconsistencies
         * between the W3C method for adding events (addEventListener) and
         * IE's (attachEvent).
         */

        // Listen for the ready event for any vimeo video players on the page
        var vimeoPlayers = document.querySelectorAll('iframe'),
            player;

        for (var i = 0, length = vimeoPlayers.length; i < length; i++) {
            player = vimeoPlayers[i];
            console.warn(player);
            $f(player).addEvent('ready', ready);
        }
    }

    function set_nickname(){
        nickname = document.getElementById('username').value;
        if(nickname){
            socket.emit('set nickname',nickname)
            console.log('set nickname',nickname)
        }else{
            alert('need a name mothafucka!');
        }
    }

    function join_room(){
        var room = document.getElementById('room').value;
        if(room){
            socket.emit('join room',room)
            console.log('join room',room)
        }else{
            alert('need a room mothafucka!');
        }
    }
    function leave_room(){
        socket.emit('leave room');
    }

    function add_video(url){
        socket.emit('add video', url);
    }

    // function check_for_duplicate_videos(video){
    //     if(video_queue.length){
    //         var is_duplicate = false;
    //         for(i in old_video_queue){
    //             if(video.url = old_video_queue[i].url){
    //                 is_duplicate = true;
    //             }
    //         }
    //         if(is_duplicate){
    //             return false
    //             video_queue.shift();
    //             check_for_duplicate_videos();
    //         }else{
    //             return video_queue.shift();
    //         }
    //     }else{
    //         return false;
    //     }
    // }

    function play_next_video(){
        if(current_video){
            old_video_queue.push(current_video);
            current_video = null;
        }
        if(video_queue){
            var video = video_queue.shift();

            if(video){
                current_video = video;

                console.log('play_video',video);
                // alert(data.current_video)

                // This is the URL of the video you want to load
                var videoUrl = video.url;

                // This is the oEmbed endpoint for Vimeo (we're using JSON)
                // (Vimeo also supports oEmbed discovery. See the PHP example.)
                var endpoint = 'http://www.vimeo.com/api/oembed.json';

                // Tell Vimeo what function to call
                var callback = 'embedVideo';

                // Put together the URL
                var url = endpoint + '?url=' + encodeURIComponent(videoUrl) + '&callback=' + callback + '&width=640&autoplay=true&api=true';


                // This function loads the data from Vimeo

                document.getElementById('from').innerHTML = 'This video is brought to you by ' + video.from;

                if(embed = document.getElementById('vimeo_embed')){
                    document.getElementsByTagName('head').item(0).removeChild(embed);
                }
                var js = document.createElement('script');
                js.setAttribute('type', 'text/javascript');
                js.setAttribute('src', url);
                js.setAttribute('id','vimeo_embed');
                document.getElementsByTagName('head').item(0).appendChild(js);
            }else{
                alert('No more videos! Add one!');
            }
        }else{
            alert('No more videos! Add one!');
        }
    }


    function show_upcoming_video(){
        
    }

      socket = io.connect('/');
      socket.on('list rooms',function(rooms){
          console.log('rooms',rooms)
          $('#rooms').empty();
          $(rooms).each(function(i,room){
              $('#rooms').append('<li>' + room.name + ' (<span>' + room.count + '</span>)</li>');
          });
      });

      socket.on('list room members',function(members){
          $('#users-in-room').empty();
          console.log(members)
          $(members).each(function(i,member){
              $('#users-in-room').append('<li>' + member + '</li>');
          });
      })

      socket.on('update video queue',function(queue){
          video_queue = queue;
          console.log('video_queue',video_queue);
          if($('iframe').length){
              // play_next_video();
          }else{
              play_next_video();
          }
      });

      socket.on('new room member',function(member){
          if(member != nickname){
              $('#users-in-room').prepend('<li>' + member + '</li>');
          }
      });

      socket.on('member left room',function(member){
          if(member == nickname){
              $('#users-in-room').empty();
              $('#current-room').empty();
          }
          console.log('member left room',member);
      });

      socket.on('nickname set',function(){
          // alert('nickname set');
      });

      socket.on('room joined',function(room){
         $('#current-room').text(room);
          // alert('room joined');
      });

      // socket.on('add video', function (video) {
      // 
      // });
    </script>
</head>
<body>

  <h1>Video Projection</h1>
  <h2>Currently in room: <span id="current-room"></span></h2>
  <a onclick="leave_room();">Leave</a>
    <h3 id="from"></h3>
    <div id="embed">Loading video...</div>
    <div>
        <form action="javascript: set_nickname()">
            <input type="text" name="username" value="" placeholder="username" id="username" >
            <input type="submit" value="Set username">
        </form>

        <form action="javascript: join_room()">
            <input type="text" name="username" value="" placeholder="room" id="room" >
            <input type="submit" value="Join room">
        </form>

        <form action="javascript: add_video(document.getElementById('new_video_url').value,document.getElementById('username').value)">
            <input type="text" name="new_video" value="" placeholder="paste your url here" id="new_video_url" >
            <input type="submit" value="Add video &rarr;">
        </form>
    </div>
    <h3>Available Rooms:</h3>
    <ul id="rooms">
    </ul>
    <h3>Room Members:</h3>
    <ul id="users-in-room">
    </ul>
</body>
</html>
